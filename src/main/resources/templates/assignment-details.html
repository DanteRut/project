<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали задания - EduSubmit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .detail-card {
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .deadline-badge {
            font-size: 0.9rem;
            padding: 8px 15px;
        }
        .file-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .submission-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .submission-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .submission-item.late {
            border-left: 4px solid #dc3545;
        }
        .submission-item.graded {
            border-left: 4px solid #28a745;
        }
        .submission-item.pending {
            border-left: 4px solid #ffc107;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="/">
            <i class="bi bi-journal-bookmark-fill me-2"></i>EduSubmit
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Главная</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/assignments/my">Мои задания</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Детали задания</a>
                </li>
            </ul>
            <div class="d-flex align-items-center">
                    <span class="me-3 text-muted">
                        <i class="bi bi-person-circle me-1"></i>
                        <span th:text="${#authentication.name}"></span>
                    </span>
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-box-arrow-right"></i> Выйти
                    </button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- Основной контент -->
<main class="container mt-4">
    <!-- Уведомления -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Заголовок и действия -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>
                <i class="bi bi-journal-text me-2"></i>
                <span th:text="${assignment.title}">Название задания</span>
            </h2>
            <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-primary">
                        <i class="bi bi-book me-1"></i>
                        <span th:text="${assignment.subject.name}">Предмет</span>
                    </span>
                <span class="badge bg-info">
                        <i class="bi bi-people me-1"></i>
                        <span th:text="${assignment.group}">Группа</span>
                    </span>
                <span class="badge"
                      th:classappend="
                            ${assignment.status == 'ACTIVE'} ? 'bg-success' :
                            (${assignment.status == 'EXPIRED'} ? 'bg-danger' :
                            (${assignment.status == 'COMPLETED'} ? 'bg-secondary' : 'bg-warning'))">
                        <span th:text="${assignment.status}">Статус</span>
                    </span>
            </div>
        </div>
        <div>
            <a href="/assignments/my" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Назад
            </a>
            <a th:if="${#authorization.expression('hasRole(''TEACHER'')')}"
               th:href="@{/assignments/delete/{id}(id=${assignment.id})}"
               class="btn btn-danger"
               onclick="return confirm('Вы уверены, что хотите удалить это задание?')">
                <i class="bi bi-trash me-1"></i> Удалить
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Левая колонка - информация о задании -->
        <div class="col-lg-8">
            <!-- Дедлайн и преподаватель -->
            <div class="card detail-card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-calendar-event me-2"></i>Дедлайн</h6>
                            <div class="d-flex align-items-center mt-2">
                                    <span>
                                        <i class="bi bi-clock me-1"></i>
                                        <span th:text="${#temporals.format(assignment.deadline, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 23:59
                                        </span>
                                    </span>
                                <span class="ms-3 text-muted small">
                                        <span th:if="${assignment.deadline.isBefore(now)}">
                                            Просрочено
                                        </span>
                                        <span th:if="${assignment.deadline.isAfter(now)}">
                                            Осталось:
                                            <span th:text="${T(java.time.temporal.ChronoUnit).DAYS.between(now, assignment.deadline)}">5</span>
                                        </span>
                                    </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-person-badge me-2"></i>Преподаватель</h6>
                            <div class="d-flex align-items-center mt-2">
                                <i class="bi bi-person-circle fs-4 text-primary me-3"></i>
                                <div>
                                    <div th:text="${assignment.teacher.fullName}">Иванов И.И.</div>
                                    <small class="text-muted" th:text="${assignment.teacher.email}">
                                        email@example.com
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Описание задания -->
            <div class="card detail-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Описание задания</h5>
                </div>
                <div class="card-body">
                    <div th:if="${assignment.description != null}" th:text="${assignment.description}">
                        Подробное описание задания...
                    </div>
                    <div th:if="${assignment.description == null}" class="text-muted">
                        Описание не предоставлено
                    </div>
                </div>
            </div>

            <!-- Прикрепленные файлы -->
            <div th:if="${assignment.assignmentFiles != null}"
                 class="card detail-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Прикрепленные файлы задания</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div th:each="file : ${assignment.assignmentFiles}"
                             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark me-3 fs-5"></i>
                                <div>
                                    <h6 class="mb-0" th:text="${file.fileName}">filename.pdf</h6>
                                    <small class="text-muted" th:text="${file.filePath}">путь к файлу</small>
                                </div>
                            </div>
                            <div>
                                <a th:href="@{'/files/' + ${file.filePath}}"
                                   target="_blank"
                                   class="btn btn-outline-primary btn-sm me-2">
                                    <i class="bi bi-download me-1"></i> Скачать
                                </a>
                                <span class="badge bg-secondary">прикреплен</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Сдача задания (для студентов) -->
            <div sec:authorize="hasAuthority('STUDENT')" th:if="{assignment.status == 'ACTIVE'}"
                 class="card detail-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Сдать задание</h5>
                </div>
                <div class="card-body">
                    <div th:if="${submissions != null}">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Вы уже сдали это задание
                        </div>
                        <a th:href="@{/submissions/submit/{id}(id=${assignment.id})}"
                           class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Пересдать
                        </a>
                    </div>
                    <div th:if="${submissions != null}">
                        <p>Загрузите файл с выполненным заданием до дедлайна</p>
                        <a th:href="@{/submissions/submit/{id}(id=${assignment.id})}"
                           class="btn btn-success">
                            <i class="bi bi-upload me-1"></i> Сдать работу
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - статистика и информация -->
        <div class="col-lg-4">
            <!-- Статистика -->
            <div class="card detail-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Статистика</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value" th:text="${assignment.maxScore ?: 100}">100</div>
                                <small>Макс. балл</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value" th:text="${submissions != null ? submissions.size() : 0}">12</div>
                                <small>Сдано работ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">
                                        <span th:if="${averageScore}">
                                                    85
                                        </span>
                                    <span th:if="${assignment.submissions == null or assignment.submissions.empty}">0</span>
                                </div>
                                <small>Средний балл</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">
                                        <span th:text="${gradedCount}">
                                            0
                                        </span>
<!--                                    <span th:if="${!submissions}">0</span>-->
                                </div>
                                <small>Оценено</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Информация о создании -->
            <div class="card detail-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Информация</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-calendar-plus me-2 text-primary"></i>
                            <strong>Создано:</strong>
                            <span th:text="${#temporals.format(assignment.createdAt, 'dd.MM.yyyy HH:mm')}">
                                    01.01.2024
                                </span>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-people me-2 text-primary"></i>
                            <strong>Группа:</strong>
                            <span th:text="${assignment.group}">УВП-312</span>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-person-badge me-2 text-primary"></i>
                            <strong>Преподаватель:</strong>
                            <span th:text="${assignment.teacher.fullName}">Иванов И.И.</span>
                        </li>
                        <li>
                            <i class="bi bi-envelope me-2 text-primary"></i>
                            <strong>Email:</strong>
                            <span th:text="${assignment.teacher.email}">teacher@example.com</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Быстрые действия -->
            <div class="card detail-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Действия</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="bi bi-printer me-1"></i> Распечатать
                        </button>
                        <a sec:authorize="hasRole('STUDENT')" th:if="${assignment.status == 'ACTIVE'}"
                           th:href="@{/submissions/submit/{id}(id=${assignment.id})}"
                           class="btn btn-success">
                            <i class="bi bi-upload me-1"></i> Сдать работу
                        </a>
                        <a th:if="${#authorization.expression('hasRole(''TEACHER'')')}"
                           href="#"
                           class="btn btn-warning">
                            <i class="bi bi-pencil me-1"></i> Редактировать
                        </a>
                        <a th:if="${#authorization.expression('hasRole(''TEACHER'')')}"
                           th:href="@{/assignments/delete/{id}(id=${assignment.id})}"
                           class="btn btn-danger"
                           onclick="return confirm('Вы уверены?')">
                            <i class="bi bi-trash me-1"></i> Удалить задание
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Сдачи студентов (для преподавателей) -->
    <div th:if="${#authorization.expression('hasRole(''TEACHER'')') && submissions != null}"
         class="card detail-card mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Сданные работы</h5>
        </div>
        <div class="card-body">
            <!-- Навигация по сдачам -->
            <ul class="nav nav-tabs mb-4" id="submissionsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all">
                        Все (<span th:text="${submissions.size()}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="graded-tab" data-bs-toggle="tab" data-bs-target="#graded">
                        Оцененные (<span th:text="${#aggregates.count(submissions.?[score != null])}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending">
                        На проверке (<span th:text="${#aggregates.count(submissions.?[score == null])}">0</span>)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="late-tab" data-bs-toggle="tab" data-bs-target="#late">
                        С опозданием (<span th:text="${#aggregates.count(submissions.?[isLate])}">0</span>)
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="submissionsTabContent">
                <!-- Все сдачи -->
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div th:each="submission : ${submissions}" class="submission-item"
                         th:classappend="${submission.isLate} ? 'late' : (${submission.score != null} ? 'graded' : 'pending')">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong th:text="${submission.student.fullName}">Студент</strong>
                                <br>
                                <small class="text-muted" th:text="${submission.student.email}">
                                    email@example.com
                                </small>
                            </div>
                            <div class="col-md-3">
                                <small>
                                    <i class="bi bi-clock me-1"></i>
                                    Сдано:
                                    <span th:text="${#temporals.format(submission.submittedAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024
                                        </span>
                                    <span th:if="${submission.isLate}" class="badge bg-danger ms-2">
                                            Опоздание
                                        </span>
                                </small>
                            </div>
                            <div class="col-md-2">
                                    <span th:if="${submission.score != null}"
                                          class="badge bg-success fs-6">
                                        <span th:text="${submission.score}">0</span>/
                                        <span th:text="${assignment.maxScore}">100</span>
                                    </span>
                                <span th:if="${submission.score == null}"
                                      class="badge bg-warning">
                                        На проверке
                                    </span>
                            </div>
                            <div class="col-md-4 text-end">
                                <a th:href="@{/submissions/grade/{id}(id=${submission.id})}"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i> Проверить
                                </a>
                                <a th:href="@{/files/{name}(name=${submission.filePath})}"
                                   target="_blank"
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-download me-1"></i> Файл
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Оцененные -->
                <div class="tab-pane fade" id="graded" role="tabpanel">
                    <div th:each="submission : ${submissions.?[score != null]}" class="submission-item graded">
                        <!-- аналогично -->
                    </div>
                </div>

                <!-- На проверке -->
                <div class="tab-pane fade" id="pending" role="tabpanel">
                    <div th:each="submission : ${submissions.?[score == null]}" class="submission-item pending">
                        <!-- аналогично -->
                    </div>
                </div>

                <!-- С опозданием -->
                <div class="tab-pane fade" id="late" role="tabpanel">
                    <div th:each="submission : ${submissions.?[isLate]}" class="submission-item late">
                        <!-- аналогично -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Моя сдача (для студентов) -->
    <div sec:authorize="hasRole('STUDENT')" th:if="${submissions != null}"
         class="card detail-card mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Моя сдача</h5>
        </div>
        <div class="card-body">
            <div th:each="submission : ${submissions}" class="submission-item"
                 th:classappend="${submission.isLate} ? 'late' : (${submission.score != null} ? 'graded' : 'pending')">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h6>Статус:</h6>
                        <span th:if="${submission.score != null}" class="badge bg-success">
                                Оценено
                            </span>
                        <span th:if="${submission.score == null}" class="badge bg-warning">
                                На проверке
                            </span>
                        <span th:if="${submission.isLate}" class="badge bg-danger ms-2">
                                С опозданием
                            </span>
                    </div>
                    <div class="col-md-3">
                        <h6>Дата сдачи:</h6>
                        <span th:text="${#temporals.format(submission.submittedAt, 'dd.MM.yyyy HH:mm')}">
                                01.01.2024
                            </span>
                    </div>
                    <div class="col-md-3">
                        <h6>Оценка:</h6>
                        <span th:if="${submission.score != null}" class="fs-4 fw-bold">
                                <span th:text="${submission.score}">0</span>/
                                <span th:text="${assignment.maxScore}">100</span>
                            </span>
                        <span th:if="${submission.score == null}" class="text-muted">
                                Ожидает проверки
                            </span>
                    </div>
                    <div class="col-md-3 text-end">
                        <a th:href="@{/files/{name}(name=${submission.filePath})}"
                           target="_blank"
                           class="btn btn-outline-primary">
                            <i class="bi bi-download me-1"></i> Скачать мою работу
                        </a>
                    </div>
                </div>
                <div th:if="${submission.feedback}" class="mt-3">
                    <h6><i class="bi bi-chat-left-text me-2"></i>Комментарий преподавателя:</h6>
                    <div class="alert alert-light">
                        <span th:text="${submission.feedback}">Комментарий...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Футер -->
<footer class="bg-light mt-5 py-4 border-top">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-journal-bookmark-fill me-2"></i>EduSubmit</h6>
                <p class="mb-0 small text-muted">Система управления учебными заданиями</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="small mb-0 text-muted">
                    <i class="bi bi-clock me-1"></i>
                    Дата просмотра: <span th:text="${#dates.format(now, 'dd.MM.yyyy HH:mm')}">
                            сегодня
                        </span>
                </p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>